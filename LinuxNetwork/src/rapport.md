# Linux network
## Part 1. ipcalc tool

### 1.1 Сети и маски

1) Адрес сети 192.167.38.54/13   ---   192.160.0.0/13

2) Перевод маски 255.255.255.0 в префиксную и двоичную запись  
Префикс - /24  
Двоичная запись - 11111111.11111111.11111111.00000000

- /15 в обычную и двоичную  
Обычная - 255.254.0.0  
Двоичная - 11111111.11111110.00000000.00000000

- 11111111.11111111.11111111.11110000 в обычную и префиксную  
Обычная - 255.255.255.240  
Префиксная - /28

3) Минимальный и максимальный хост в сети 12.167.38.4 при масках: /8, 11111111.11111111.00000000.00000000, 255.255.254.0 и /4

- /8  
HostMin - 12.0.0.1  
HostMax - 12.255.255.254

- 11111111.11111111.00000000.00000000 (/16)  
HostMin - 12.167.0.1  
HostMax - 12.167.255.254

- 255.255.254.0 (/23)  
HostMin - 12.167.38.1  
HostMax - 12.167.39.254

- /4  
HostMin - 0.0.0.1  
HostMax - 15.255.255.254

### 1.2 localhost

- Определить и записать в отчёт, можно ли обратиться к приложению, работающему на localhost, со следующими IP: 194.34.23.100, 127.0.0.2, 127.1.0.1, 128.0.0.1

- Можно обратиться если адрес находится в диапазоне 127.0.0.1 — 127.255.255.254
- В нашем случае это адреса: 127.0.0.2, 127.1.0.1

### 1.3 Диапазоны и сегменты сетей

1) какие из перечисленных IP можно использовать в качестве публичного, а какие только в качестве частных: 10.0.0.45, 134.43.0.2, 192.168.4.2, 172.20.250.4, 172.0.2.1, 192.172.0.1, 172.68.0.2, 172.16.255.255, 10.10.10.10, 192.169.168.1

- Публичные: 134.43.0.2, 172.0.2.1, 192.172.0.1, 172.68.0.2, 192.169.168.1
- Частные: 10.0.0.45, 192.168.4.2, 172.20.250.4, 172.16.255.255, 10.10.10.10

## Part 2. Static routing between two machines

- С помощью команды ip a посмотреть существующие сетевые интерфейсы

- Описать сетевой интерфейс, соответствующий внутренней сети, на обеих машинах и задать следующие адреса и маски: ws1 - 192.168.100.10, маска /16, ws2 - 172.24.116.8, маска /12

- Содержание изменённого файла etc/netplan/00-installer-config.yaml и  
Команда `netplan apply`

![part1](src/images/2_123.png)

### 2.1. Добавление статического маршрута вручную

- Добавить статический маршрут от одной машины до другой и обратно при помощи команды вида ip r add  
Пропинговать соединение между машинами

![part1](src/images/2_4.png)

### 2.2. Добавление статического маршрута с сохранением

- Перезапустить машины

- Добавить статический маршрут от одной машины до другой с помощью файла etc/netplan/00-installer-config.yaml

- Пропинговать соединение между машинами

![part1](src/images/2.2.png)

## Part 3. iperf3 utility


### 3.1 Скорость соединения

- Перевести и записать в отчёт:  
8 Mbps = 1 MB/s  
100 MB/s = 800 000 Kbps  
1 Gbps = 1000 Mbps

### 3.2 Утилита iperf3

- Измерить скорость соединения между ws1 и ws2

![part1](src/images/3.png)

## Part 4. Network firewall

### 4.1. Утилита iptables

- Создать файл /etc/firewall.sh, имитирующий фаерволл, на ws1 и ws2

- Нужно добавить в файл подряд следующие правила:

1) на ws1 применить стратегию когда в начале пишется запрещающее правило, а в конце пишется разрешающее правило (это касается пунктов 4 и 5)

2) на ws2 применить стратегию когда в начале пишется разрешающее правило, а в конце пишется запрещающее правило (это касается пунктов 4 и 5)

3) открыть на машинах доступ для порта 22 (ssh) и порта 80 (http)

4) запретить echo reply (машина не должна "пинговаться”, т.е. должна быть блокировка на OUTPUT)

5) разрешить echo reply (машина должна "пинговаться")

- содержание файла /etc/firewall.sh и запуск файлов командами `chmod +x /etc/firewall.sh` и `/etc/firewall.sh`

![part1](src/images/4.1.png)

- Удаление существующих правил  
`iptables -F`  
`iptables -X`

`iptables -A INPUT -p tcp --dport .. -j ACCEPT`:  
`-A` - добавление правила в цепочку,  
`-p` - протокол tcp,  
`--dport` - номер порта,  
`-j ACCEPT` - разрешить соединение

- В первом случае машина должна "пинговаться" (`echo-reply`), поэтому она доставит сообщение о том, что пакеты получены. Вторая машина не отправит это сообщение, потому что мы ей запретили `echo-reply`

### 4.2. Утилита nmap

- Командой ping найти машину, которая не "пингуется", после чего утилитой nmap показать, что хост машины запущен

- Вызов команд `ping` и `nmap`. Наличие вывода `Host is up`

![part1](src/images/4.2.png)

## Part 5. Static network routing

### 5.1. Настройка адресов машин

- Настроить конфигурации машин в etc/netplan/00-installer-config.yaml согласно сети на рисунке.

- ws11

![part1](src/images/5.1_ws11.png)

- ws21

![part1](src/images/5.1_ws21.png)

- ws22

![part1](src/images/5.1_ws22.png)

- r1

![part1](src/images/5.1_r1.png)

- wsr2

![part1](src/images/5.1_r2.png)

- Перезапустить сервис сети. Если ошибок нет, то командой ip -4 a проверить, что адрес машины задан верно. Также пропинговать ws22 с ws21. Аналогично пропинговать r1 с ws11.

- Пингуем ws22 с ws21

![part1](src/images/5.1_ping_ws22.png)

- Пингуем r1 с ws11

![part1](src/images/5.1_ping_r1.png)

### 5.2. Включение переадресации IP-адресов

- Выполнение команды `sysctl -w net.ipv4.ip_forward=1`

- r1

![part1](src/images/5.2_1.png)

- r2

![part1](src/images/5.2_2.png)

- Изменение файла /etc/sysctl.conf

![part1](src/images/5.2_3.png)

### 5.3. Установка маршрута по-умолчанию

- Настроить маршрут по-умолчанию (шлюз) для рабочих станций. Для этого добавить default перед IP роутера в файле конфигураций
- Вызвать ip r и показать, что добавился маршрут в таблицу маршрутизации

- ws11

![part1](src/images/5.3_ws11.png)

- ws21

![part1](src/images/5.3_ws21.png)

- ws22

![part1](src/images/5.3_ws22.png)

- Пропинговать с ws11 роутер r2 и показать на r2, что пинг доходит командой `tcpdump -tn -i eth1`

![part1](src/images/5.3_ping_r2.png)

### 5.4. Добавление статических маршрутов

- Добавить в роутеры r1 и r2 статические маршруты в файле конфигураций

- Содержание etc/netplan/00-installer-config.yaml для каждого роутера

- r1 

![part1](src/images/5.4_r1.png)

- r2

![part1](src/images/5.4_r2.png)

- Запустить команды на ws11:  
`ip r list 10.10.0.0/[маска сети]` и `ip r list 0.0.0.0/0`

![part1](src/images/5.4_ws11.png)

- В отчёте объяснить, почему для адреса 10.10.0.0/[маска сети] был выбран маршрут, отличный от 0.0.0.0/0, хотя он попадает под маршрут по-умолчанию.  
Потому что адрес 0.0.0.0 - это не маршрутизируемый мета-адрес, который используется для определения неизвестного или недействительного целевого объекта. 0.0.0.0 означает все адреса IPv4 на локальной машине, в случае записи маршрута это означает маршрут по умолчанию.

### 5.5. Построение списка маршрутизаторов

- Запустить на r1 команду дампа:
`tcpdump -tnv -i eth0`

- При помощи утилиты traceroute построить список маршрутизаторов на пути от ws11 до ws21

![part1](src/images/5.5_r1_1.png)

![part1](src/images/5.5_ws11.png)

- В отчёте, опираясь на вывод, полученный из дампа на r1, объяснить принцип работы построения пути при помощи traceroute.  
`traceroute` отправляет серию пакетов целевому узлу, который есть в пути следования от одной машины к другой, каждый раз увелчивая на 1 значение поля TTL, который отображает количество маршрутизаторов, возможных для прохождения пакетом. Процесс будет продолжаться до тех пор, кока при определенном значении TTL пакет не достигнет целевого узла. Если достиг - процесс считается завершенным.

### 5.6. Использование протокола ICMP при маршрутизации

- Запустить на r1 перехват сетевого трафика, проходящего через eth0 с помощью команды:  
`tcpdump -n -i eth0 icmp`

- Пропинговать с ws11 несуществующий IP (например, 10.30.0.111) с помощью команды:  
`ping -c 1 10.30.0.111`

![part1](src/images/5.6.png)

## Part 6. Dynamic IP configuration using DHCP

- Для r2 настроить в файле /etc/dhcp/dhcpd.conf конфигурацию службы DHCP:

![part1](src/images/6_dhcpdconf_r1.png)

- в файле resolv.conf прописать nameserver 8.8.8.8

![part1](src/images/6_resolvconf_r1.png)

- Перезагрузить службу DHCP командой `systemctl restart isc-dhcp-server`. Машину ws21 перезагрузить при помощи `reboot` и через `ip a` показать, что она получила адрес. Также пропинговать ws22 с ws21.

- Перезагрузка службы DHCP

![part1](src/images/6_restart.png)

![part1](src/images/6_status_r2.png)

- ip a ws21

![part1](src/images/6_ipa_ws21.png)

- ping ws22 с ws21

![part1](src/images/6_ping_ws22.png)

- Указать MAC адрес у ws11, для этого в etc/netplan/00-installer-config.yaml надо добавить строки: `macaddress: 10:10:10:10:10:BA`, `dhcp4: true`

![part1](src/images/6_ws11.png)

- Для r1 настроить аналогично r2, но сделать выдачу адресов с жесткой привязкой к MAC-адресу (ws11). Провести аналогичные тесты

- /etc/dhcp/dhcpd.conf

![part1](src/images/6_dhcpdconf_r2.png)

- resolv.conf

![part1](src/images/6_resolvconf_r2.png)

- Запросить с ws21 обновление ip адреса

- ip до обновления

![part1](src/images/6_ip_before_ws21.png)

- ip после обновления

![part1](src/images/6_ip_after_ws21.png)

- В отчёте описать, какими опциями DHCP сервера пользовались в данном пункте.  
`sudo dhclient [name]` - Выдача адреса интерфейсу  
`sudo dhclient -r` - удаление существующих адресов и выдача новых
в фале etc/netplan/00-installer-config.yaml нужно прописать `dhcp4: true`, чтобы адреса выдавались автоматически с сервера

## Part 7. NAT

- В файле /etc/apache2/ports.conf на ws22 и r1 изменить строку `Listen 80` на `Listen 0.0.0.0:80`, то есть сделать сервер Apache2 общедоступным

![part1](src/images/7_ports_r1.png)

- Запустить веб-сервер Apache командой `service apache2 start` на ws22 и r1

- r1

![part1](src/images/7_apache2_start_r1.png)

- ws22

![part1](src/images/7_apache2_start_ws22.png)

- Добавить в фаервол, созданный по аналогии с фаерволом из Части 4, на r2 следующие правила:  
1) Удаление правил в таблице filter - `iptables -F`  
2) Удаление правил в таблице "NAT" - `iptables -F -t nat`  
3) Отбрасывать все маршрутизируемые пакеты - `iptables --policy FORWARD DROP`  
Запускать файл также, как в Части 4

![part1](src/images/7_firewall_r2.png)

- Проверить соединение между ws22 и r1 командой `ping`

![part1](src/images/7_ping_1.png)

![part1](src/images/7_ping_2.png)

- Добавить в файл ещё одно правило:  
4) Разрешить маршрутизацию всех пакетов протокола ICMP  
Запускать файл также, как в Части 4

![part1](src/images/7_firewall2_r2.png)

- Проверить соединение между ws22 и r1 командой `ping`

![part1](src/images/7_ping_3.png)

![part1](src/images/7_ping_4.png)

- Добавить в файл ещё два правила:  
5) Включить SNAT, а именно маскирование всех локальных ip из локальной сети, находящейся за r2 (по обозначениям из Части 5 - сеть 10.20.0.0)  
6) Включить DNAT на 8080 порт машины r2 и добавить к веб-серверу Apache, запущенному на ws22, доступ извне сети  
Запускать файл также, как в Части 4

![part1](src/images/7_firewall3_r2.png)

- Проверить соединение по TCP для SNAT, для этого с ws22 подключиться к серверу Apache на r1 командой:  
`telnet [адрес] [порт]`

![part1](src/images/7_connect_to_r1.png)

- Проверить соединение по TCP для DNAT, для этого с r1 подключиться к серверу Apache на ws22 командой `telnet` (обращаться по адресу r2 и порту 8080)

![part1](src/images/7_connect_to_ws22.png)

## Part 8. Bonus. Introduction to SSH Tunnels

- Запустить на r2 фаервол с правилами из Части 7

- Запустить веб-сервер Apache на ws22 только на localhost (то есть в файле /etc/apache2/ports.conf изменить строку Listen 80 на Listen localhost:80)

- ports.conf

![part1](src/images/8_ports_ws22.png)

- status `systemctl status apache2`

![part1](src/images/8_apache_status_ws22.png)

- Воспользоваться Local TCP forwarding с ws21 до ws22, чтобы получить доступ к веб-серверу на ws22 с ws21

- `ssh -L 8080:10.20.0.20:80 [name]@10.20.0.20`, вводим пароль и заходим в машину ws22

![part1](src/images/8_ssh_to_ws22.png)

- Воспользоваться Remote TCP forwarding c ws11 до ws22, чтобы получить доступ к веб-серверу на ws22 с ws11

- `ssh -R 80:10.20.0.20:8080 [name]@10.20.0.20`, вводим пароль и заходим в машину ws22

![part1](src/images/8_ssh2_to_ws22.png)

- Для проверки, сработало ли подключение в обоих предыдущих пунктах, перейдите во второй терминал (например, клавишами Alt + F2) и выполните команду:  

- `telnet 127.0.0.1 [локальный порт]`

![part1](src/images/8_telnet_to_ws22.png)

![part1](src/images/8_telnet2_to_ws22.png)
